# All-in-One Dockerfile: Redis + FastAPI + ARQ Worker
# ⚠️ WARNING: Not recommended for production, pero OK for testing!
# 
# This runs all services in one container:
# - Redis (background)
# - FastAPI (main process)
# - ARQ Worker (background)

FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies (including Redis)
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    redis-server \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Install UV (fast Python package manager)
RUN pip install --no-cache-dir uv

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Install dependencies using UV
RUN uv sync --frozen

# Copy application code
COPY . .

# Create supervisor config for managing multiple processes
RUN mkdir -p /etc/supervisor/conf.d
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create non-root user for security
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app && \
    mkdir -p /var/log/supervisor && \
    mkdir -p /var/lib/redis && \
    mkdir -p /var/run/supervisor && \
    chown -R appuser:appuser /var/log/supervisor && \
    chown -R appuser:appuser /var/lib/redis && \
    chown -R appuser:appuser /var/run/supervisor

# Expose ports
EXPOSE 8000 6379

# Use supervisor to manage all processes
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

